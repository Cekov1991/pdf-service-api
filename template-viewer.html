<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template Viewer - Edit & Preview</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.8/handlebars.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1e1e1e;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }
        .container {
            display: flex;
            height: 100vh;
        }
        .editor-panel {
            width: 50%;
            display: flex;
            flex-direction: column;
            background: #252526;
            border-right: 1px solid #3e3e42;
        }
        .preview-panel {
            width: 50%;
            background: white;
            overflow: auto;
        }
        .toolbar {
            padding: 12px 16px;
            background: #2d2d30;
            border-bottom: 1px solid #3e3e42;
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .toolbar h2 {
            font-size: 14px;
            font-weight: 500;
            flex: 1;
        }
        button {
            padding: 6px 16px;
            background: #0e639c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
        }
        button:hover {
            background: #1177bb;
        }
        button.secondary {
            background: #3e3e42;
        }
        button.secondary:hover {
            background: #505050;
        }
        #templateEditor {
            flex: 1;
            padding: 16px;
            background: #1e1e1e;
            color: #d4d4d4;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.6;
            border: none;
            resize: none;
            outline: none;
        }
        #preview {
            padding: 40px;
            min-height: 100%;
        }
        .status {
            padding: 8px 16px;
            background: #2d2d30;
            border-top: 1px solid #3e3e42;
            font-size: 12px;
            color: #858585;
        }
        .status.success {
            background: #1a3d1a;
            color: #4ec94e;
        }
        .status.error {
            background: #3d1a1a;
            color: #f48771;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Editor Panel -->
        <div class="editor-panel">
            <div class="toolbar">
                <h2>üìù Template Editor</h2>
                <button id="refreshBtn">üîÑ Refresh Preview</button>
                <button class="secondary" id="resetBtn">‚Ü∫ Reset</button>
            </div>
            <textarea id="templateEditor" spellcheck="false"></textarea>
            <div class="status" id="status">Ready to edit. Press "Refresh Preview" to update.</div>
        </div>

        <!-- Preview Panel -->
        <div class="preview-panel">
            <div id="preview"></div>
        </div>
    </div>

    <script>
        // Mock data from your example payload
        const mockData = {
            "labels": {
                "visit_report": "Visit Report",
                "generated_on": "Generated on",
                "patient_information": "Patient Information",
                "full_name": "Full Name",
                "dob": "Date of Birth",
                "sex": "Sex",
                "unique_master_citizen_number": "Citizen Number",
                "phone": "Phone",
                "email": "Email",
                "visit_information": "Visit Information",
                "scheduled_at": "Scheduled At",
                "type": "Type",
                "status": "Status",
                "doctor": "Doctor",
                "reason_for_visit": "Reason for Visit",
                "anamnesis": "Anamnesis",
                "chief_complaint": "Chief Complaint",
                "history_of_present_illness": "History of Present Illness",
                "past_medical_history": "Past Medical History",
                "family_history": "Family History",
                "medications_current": "Current Medications",
                "allergies": "Allergies",
                "therapy_in_use": "Therapy in Use",
                "other_notes": "Other Notes",
                "examination": "Ophthalmic Examination",
                "visus_od": "Visual Acuity OD",
                "visus_os": "Visual Acuity OS",
                "iop_od": "IOP OD",
                "iop_os": "IOP OS",
                "anterior_segment_findings_od": "Anterior Segment OD",
                "anterior_segment_findings_os": "Anterior Segment OS",
                "posterior_segment_findings_od": "Posterior Segment OD",
                "posterior_segment_findings_os": "Posterior Segment OS",
                "refraction_title": "Refraction Data",
                "eye": "Eye",
                "method": "Method",
                "sphere": "Sphere",
                "cylinder": "Cylinder",
                "axis": "Axis",
                "add_power": "Add Power",
                "notes": "Notes",
                "diagnoses": "Diagnoses",
                "code": "Code",
                "term": "Term",
                "onset_date": "Onset Date",
                "is_primary": "Primary",
                "yes": "Yes",
                "no": "No",
                "imaging": "Imaging Studies",
                "modality": "Modality",
                "imaging_status": "Status",
                "findings": "Findings",
                "treatments": "Treatment Plans",
                "plan_type": "Plan Type",
                "recommendation": "Recommendation",
                "details": "Details",
                "planned_date": "Planned Date",
                "prescriptions": "Prescriptions",
                "prescription": "Prescription",
                "medication_name": "Medication",
                "dosage": "Dosage",
                "frequency": "Frequency",
                "duration": "Duration",
                "instructions": "Instructions",
                "spectacles": "Spectacle Prescriptions",
                "add": "Add",
                "prism": "Prism",
                "pd": "PD",
                "doctor_signature": "Doctor's Signature",
                "date": "Date",
                "no_anamnesis_recorded": "No anamnesis data recorded",
                "no_examination_recorded": "No examination data recorded",
                "no_diagnoses_recorded": "No diagnoses recorded",
                "no_imaging_recorded": "No imaging studies recorded",
                "no_treatments_recorded": "No treatments recorded",
                "no_prescriptions_recorded": "No prescriptions recorded",
                "no_spectacles_recorded": "No spectacle prescriptions recorded"
            },
            "patient": {
                "full_name": "John Michael Doe",
                "dob": "1985-03-15",
                "sex": "Male",
                "unique_master_citizen_number": "1234567890123",
                "phone": "+1-555-0123",
                "email": "john.doe@example.com"
            },
            "visit": {
                "scheduled_at": "2025-11-16T10:00:00",
                "type": "Follow-up",
                "status": "Completed",
                "reason_for_visit": "Annual eye examination and prescription update"
            },
            "doctor": {
                "name": "Dr. Sarah Johnson"
            },
            "anamnesis": {
                "chief_complaint": "Patient reports blurry vision when reading",
                "history_of_present_illness": "Progressive difficulty reading for the past 6 months",
                "past_medical_history": "Hypertension, well controlled",
                "family_history": "Mother has glaucoma",
                "medications_current": "Lisinopril 10mg daily",
                "allergies": "None known",
                "therapy_in_use": "None",
                "other_notes": "Patient is cooperative and compliant"
            },
            "ophthalmic_exam": {
                "visus_od": "20/40",
                "visus_os": "20/30",
                "iop_od": "16 mmHg",
                "iop_os": "15 mmHg",
                "anterior_segment_findings_od": "Clear cornea, deep AC, no inflammation",
                "anterior_segment_findings_os": "Clear cornea, deep AC, no inflammation",
                "posterior_segment_findings_od": "Healthy optic disc, intact macula",
                "posterior_segment_findings_os": "Healthy optic disc, intact macula",
                "refractions": [
                    {
                        "eye": "OD",
                        "method": "Subjective",
                        "sphere": "-1.25",
                        "cylinder": "-0.50",
                        "axis": "90",
                        "add_power": "+2.00",
                        "notes": "Best corrected"
                    },
                    {
                        "eye": "OS",
                        "method": "Subjective",
                        "sphere": "-1.00",
                        "cylinder": "-0.75",
                        "axis": "85",
                        "add_power": "+2.00",
                        "notes": "Best corrected"
                    }
                ]
            },
            "diagnoses": [
                {
                    "code": "H52.4",
                    "term": "Presbyopia",
                    "onset_date": "2024-05-01",
                    "is_primary": true,
                    "notes": "Age-related near vision difficulty"
                },
                {
                    "code": "H52.1",
                    "term": "Myopia",
                    "onset_date": "2010-01-01",
                    "is_primary": false,
                    "notes": "Mild myopia, stable"
                }
            ],
            "imaging_studies": [
                {
                    "modality": "OCT",
                    "eye": "OU",
                    "status": "Completed",
                    "findings": "Normal retinal thickness, no signs of macular degeneration"
                }
            ],
            "treatment_plans": [
                {
                    "plan_type": "Optical Correction",
                    "recommendation": "Progressive lenses",
                    "details": "Update spectacle prescription with progressive addition lenses",
                    "start_date": "2025-11-16"
                }
            ],
            "prescriptions": [
                {
                    "notes": "Use as directed",
                    "prescription_items": [
                        {
                            "medication_name": "Artificial Tears",
                            "dosage": "1-2 drops",
                            "frequency": "4 times daily",
                            "duration": "Ongoing",
                            "instructions": "Apply to both eyes as needed for dryness"
                        }
                    ]
                }
            ],
            "spectacle_prescriptions": [
                {
                    "eye": "OD",
                    "sphere": "-1.25",
                    "cylinder": "-0.50",
                    "axis": "90",
                    "add_power": "+2.00",
                    "prism": null,
                    "pupillary_distance": "32"
                },
                {
                    "eye": "OS",
                    "sphere": "-1.00",
                    "cylinder": "-0.75",
                    "axis": "85",
                    "add_power": "+2.00",
                    "prism": null,
                    "pupillary_distance": "32"
                }
            ],
            "generated_at": "2025-11-16T14:30:00",
            "current_date": "2025-11-16"
        };

        let originalTemplate = '';

        // Load the template
        async function loadTemplate() {
            try {
                const response = await fetch('./src/templates/reports/anamnesis.html');
                const template = await response.text();
                originalTemplate = template;
                document.getElementById('templateEditor').value = template;
                renderTemplate();
            } catch (error) {
                showStatus('‚ùå Error loading template: ' + error.message, 'error');
            }
        }

        function renderTemplate() {
            try {
                const templateSource = document.getElementById('templateEditor').value;
                const template = Handlebars.compile(templateSource);
                const html = template(mockData);
                document.getElementById('preview').innerHTML = html;
                showStatus('‚úÖ Template rendered successfully!', 'success');
            } catch (error) {
                showStatus('‚ùå Error: ' + error.message, 'error');
            }
        }

        function resetTemplate() {
            if (confirm('Reset to original template? Your changes will be lost.')) {
                document.getElementById('templateEditor').value = originalTemplate;
                renderTemplate();
            }
        }

        function showStatus(message, type = '') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
        }

        // Button event listeners
        document.getElementById('refreshBtn').addEventListener('click', renderTemplate);
        document.getElementById('resetBtn').addEventListener('click', resetTemplate);

        // Keyboard shortcut: Ctrl/Cmd + S to refresh
        document.getElementById('templateEditor').addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                renderTemplate();
            }
        });

        // Load template on page load
        loadTemplate();
    </script>
</body>
</html>

